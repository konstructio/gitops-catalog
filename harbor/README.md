# Harbor GitOps Catalog Application

## Overview

This Harbor deployment is configured for the Kubefirst GitOps catalog with:
- HTTPS ingress at `harbor.<DOMAIN_NAME>`
- External secrets integration with Vault
- Persistent storage for all components
- Trivy vulnerability scanning enabled

## Required Vault Configuration

Before deploying Harbor, configure the following secrets in Vault:

```bash
vault kv put secret/harbor \
  HARBOR_ADMIN_PASSWORD="your-secure-admin-password" \
  POSTGRES_PASSWORD="your-secure-db-password" \
  REDIS_PASSWORD="your-secure-redis-password"
```

## Token Service Private Key

Harbor automatically generates the required private key for its token service during deployment. This ensures Docker authentication works properly without storing any sensitive keys in Git.

## Known Issues Resolved

### Docker Login 500 Error
If you encounter a 500 error during `docker login`, check that Harbor has successfully auto-generated its token service keys. The Harbor Helm chart handles this automatically when deployed correctly.

### Database "relation properties does not exist" Error
This error occurs when the Harbor database isn't properly initialized. Ensure all external secrets are created before deploying Harbor.

## Components

- **Core**: Harbor's main API server
- **Portal**: Web UI
- **Registry**: Docker registry
- **Database**: PostgreSQL (internal)
- **Redis**: Cache and session storage (internal)
- **Trivy**: Vulnerability scanner
- **Jobservice**: Background job processing

## Troubleshooting

Check component logs:
```bash
kubectl logs -n harbor -l component=core
kubectl logs -n harbor -l component=registry
kubectl logs -n harbor -l component=jobservice
```

Verify all secrets are created:
```bash
kubectl get secrets -n harbor
```

The deployment should create:
- `harbor-admin-secret` - Admin credentials (from Vault)
- `harbor-database-secret` - PostgreSQL password (from Vault)
- `harbor-redis-secret` - Redis password (from Vault)
- `harbor-core` - Core component secrets including token signing keys (auto-generated by Harbor)